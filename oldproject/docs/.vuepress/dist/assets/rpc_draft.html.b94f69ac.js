import{_ as n,o as s,c as e,e as a}from"./app.59b4e306.js";const t={},i=a(`<h1 id="rpc\u89E3\u6790" tabindex="-1"><a class="header-anchor" href="#rpc\u89E3\u6790" aria-hidden="true">#</a> rpc\u89E3\u6790</h1><h2 id="user-proto" tabindex="-1"><a class="header-anchor" href="#user-proto" aria-hidden="true">#</a> user.proto</h2><p>\u8BF7\u6C42\u4E0E\u8FD4\u56DE\u7684\u7C7B\u578B\u5B9A\u4E49.</p><div class="language-proto ext-proto line-numbers-mode"><pre class="language-proto"><code>syntax = &quot;proto3&quot;;

package user;
option go_package=&quot;./user&quot;;

message ReqLoginUser {
  string username = 1;
  string password = 2;
}

message RespLoginUser {
  string token = 1;
}

message ReqAddUser {
  string username = 1;
  string password = 2;
  string email = 3;
}

message MsgResp {
  int64 code = 1;
  string msg = 2;
}

message UserId {
  int64 id = 1;
}

message UserInfo {
  int64 id = 1;
  string username = 2;
  string email = 3;
}

service User {
  rpc login(ReqLoginUser) returns(RespLoginUser);
  rpc add(ReqAddUser) returns(MsgResp);
  rpc get(UserId) returns(UserInfo);
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="user-go" tabindex="-1"><a class="header-anchor" href="#user-go" aria-hidden="true">#</a> user.go</h2><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// \u547D\u4EE4\u884C\u914D\u7F6E</span>
<span class="token keyword">var</span> configFile <span class="token operator">=</span> flag<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token string">&quot;f&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;etc/user.yaml&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;the config file&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	flag<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// \u5B9E\u4F8B\u5316\u914D\u7F6E\u6587\u4EF6</span>
	<span class="token keyword">var</span> c config<span class="token punctuation">.</span>Config
	conf<span class="token punctuation">.</span><span class="token function">MustLoad</span><span class="token punctuation">(</span><span class="token operator">*</span>configFile<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">)</span>
    <span class="token comment">// \u6784\u9020\u4E0A\u4E0B\u6587\uFF0C\u5E76\u628A\u914D\u7F6E\u6CE8\u5165ctx\u4E2D</span>
	<span class="token comment">// \u8BE5\u4E0A\u4E0B\u6587\u4E3B\u8981\u5305\u542B\u4E86config\uFF0Cmodel</span>
	ctx <span class="token operator">:=</span> svc<span class="token punctuation">.</span><span class="token function">NewServiceContext</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
    <span class="token comment">// \u901A\u8FC7config\u4E2D\u7684rpc\u670D\u52A1\u914D\u7F6E\uFF0C\u542F\u52A8\u670D\u52A1</span>
	s <span class="token operator">:=</span> zrpc<span class="token punctuation">.</span><span class="token function">MustNewServer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>RpcServerConf<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>grpcServer <span class="token operator">*</span>grpc<span class="token punctuation">.</span>Server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// \u4E3A\u542F\u52A8\u7684\u670D\u52A1\uFF0C\u6CE8\u518C\u4E1A\u52A1\u670D\u52A1\uFF0C\u4E1A\u52A1\u670D\u52A1\u5C31\u662Fproto\u4E2D\u5B9A\u4E49\u7684services</span>
		user<span class="token punctuation">.</span><span class="token function">RegisterUserServer</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">,</span> server<span class="token punctuation">.</span><span class="token function">NewUserServer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">)</span>

		<span class="token keyword">if</span> c<span class="token punctuation">.</span>Mode <span class="token operator">==</span> service<span class="token punctuation">.</span>DevMode <span class="token operator">||</span> c<span class="token punctuation">.</span>Mode <span class="token operator">==</span> service<span class="token punctuation">.</span>TestMode <span class="token punctuation">{</span>
			reflection<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>grpcServer<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> s<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Starting rpc server at %s...\\n&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">.</span>ListenOn<span class="token punctuation">)</span>
	s<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="etc-user-yaml" tabindex="-1"><a class="header-anchor" href="#etc-user-yaml" aria-hidden="true">#</a> etc/user.yaml</h2><p>\u5176\u5BF9\u5E94\u4E86rpc\u670D\u52A1\u7684\u914D\u7F6E\uFF0C\u4EE5\u53CAetcd\u914D\u7F6E\uFF0C\u8FD8\u6709\u6570\u636E\u5E93\u914D\u7F6E\uFF0Credis\u7F13\u5B58\u914D\u7F6E</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">Name</span><span class="token punctuation">:</span> user.rpc
<span class="token key atrule">ListenOn</span><span class="token punctuation">:</span> 0.0.0.0<span class="token punctuation">:</span><span class="token number">8080</span>
<span class="token key atrule">Etcd</span><span class="token punctuation">:</span>
  <span class="token key atrule">Hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span>
  <span class="token key atrule">Key</span><span class="token punctuation">:</span> user.rpc
<span class="token key atrule">DataSource</span><span class="token punctuation">:</span> root<span class="token punctuation">:</span>123456@tcp(localhost<span class="token punctuation">:</span>3306)/gozerodemo
<span class="token key atrule">Table</span><span class="token punctuation">:</span> user
<span class="token key atrule">Cache</span><span class="token punctuation">:</span> 
  <span class="token punctuation">-</span> <span class="token key atrule">Host</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">6379</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="types-user-user-pb-go" tabindex="-1"><a class="header-anchor" href="#types-user-user-pb-go" aria-hidden="true">#</a> types/user/user.pb.go</h2><p>pb\u662Fproto buffer\uFF0C\u8868\u793A\u662Fproto\u751F\u6210\u5F97\u4EE3\u7801\u3002</p><p>\u5305\u542B\u4E86proto\u4E2D\uFF0C\u53C2\u6570\u8BF7\u6C42\u4E0E\u8FD4\u56DE\u7684\u7C7B\u578B\u5B9A\u4E49\uFF0C\u4EE5\u53CA\u4E3A\u5176\u6DFB\u52A0\u4E86\u4E00\u4E9B\u57FA\u7840\u65B9\u6CD5\u3002</p><h2 id="types-user-user-grpc-pb-go" tabindex="-1"><a class="header-anchor" href="#types-user-user-grpc-pb-go" aria-hidden="true">#</a> types/user/user_grpc.pb.go</h2><h3 id="client\u5B9A\u4E49" tabindex="-1"><a class="header-anchor" href="#client\u5B9A\u4E49" aria-hidden="true">#</a> client\u5B9A\u4E49</h3><p>\u5B9A\u4E49userClient,userServer\u76F8\u5173\u7684\u7ED3\u6784\u4F53\uFF0C\u7ED3\u6784\uFF0C\u65B9\u6CD5\u5B9A\u4E49</p><p>\u9996\u5148\u5B9A\u4E49\u4E00\u7EC4\u5E38\u91CF\uFF0C\u63CF\u8FF0\u5B9A\u4E49\u5F97\u65B9\u6CD5\uFF0C\u5728service\u4E2D\u7684\u5177\u4F53\u8DEF\u5F84\u3002</p><p>\u63A5\u7740\uFF0C\u5B9A\u4E49\u4E86UserClient\u8FD9\u4E2Ainterface\uFF0C\u5176\u58F0\u660E\u4E86\u4E1A\u52A1\u65B9\u6CD5\u3002</p><p>\u5B9A\u4E49userClient\u7ED3\u6784\u4F53\uFF0C\u4E0E\u5176New\u65B9\u6CD5\u3002 \u7ED3\u6784\u4F53\u5185\u90E8\u5C5E\u6027\u662F<code>cc grpc.ClientConnInterface</code>\uFF0C\u5176\u5728\u8C03\u7528new\u5B9E\u4F8B\u5316\u65F6\u4F20\u5165\u3002</p><p>userClient\u4F5C\u4E3Areceiver\uFF0C\u5728\u5176\u4E0A\u5B9A\u4E49\u4E86\u4E1A\u52A1\u65B9\u6CD5Login\u7B49\uFF0C\u5176\u5B9E\u73B0\u4E86UserClient\u63A5\u53E3\u3002</p><p>\u4E1A\u52A1\u65B9\u6CD5\uFF0C\u4F8B\u5982Login\uFF0C\u5185\u90E8\u5B9E\u73B0\uFF0C\u662F\u4F7F\u7528client\u4E2D\u7684cc\uFF0C\u4E5F\u5C31\u662FClientConnInterface\u4E0A\u7684Invoke\u65B9\u6CD5\uFF0C \u8C03\u7528\u6700\u5F00\u59CB\u5B9A\u4E49\u5F97\u65B9\u6CD5\u5168\u8DEF\u5F84\uFF0C\u5E76\u4F20\u5165\u8BF7\u6C42\u548C\u8FD4\u56DE\u7684\u6307\u9488\u3002Invoke\u5B8C\u6210\u540E\uFF0Cresp\u7ED3\u6784\u4F53\u5185\u5C31\u6709\u4E86\u6570\u636E\u3002</p><h3 id="server\u5B9A\u4E49" tabindex="-1"><a class="header-anchor" href="#server\u5B9A\u4E49" aria-hidden="true">#</a> server\u5B9A\u4E49</h3><p>\u5B9A\u4E49UserServer\u63A5\u53E3\uFF0C\u5305\u542B\u4E86\u4E1A\u52A1\u65B9\u6CD5\u58F0\u660E\u3002</p><p>\u5B9A\u4E49\u4E00\u4E2AUnimplementedUserServer\u7ED3\u6784\u4F53\uFF0C\u987E\u540D\u601D\u4E49\uFF0C\u4E5F\u5C31\u662F\u672A\u5B9E\u73B0\u7684Server\uFF0C\u5176\u4E1A\u52A1\u65B9\u6CD5\u90FD\u8FD4\u56DEerror\u3002</p><p>\u5B9A\u4E49UnsafeUserServer\uFF0C\u4E0D\u77E5\u9053\u5E72\u5565\u7528\u7684\u3002</p><p>\u5B9A\u4E49\u4E86\u4E1A\u52A1handler\u65B9\u6CD5\uFF0C\u4F8B\u5982<code> _User_Login_Handler</code>,\u4E3A\u4EC0\u4E48\u4F1A\u6709\u8FD9\u5C42handler\u5462\uFF1F</p><p>\u5B9A\u4E49\u53D8\u91CF User_ServiceDesc\uFF0C\u63CF\u8FF0\u4E86\u670D\u52A1\u7684\u540D\u5B57\uFF0C\u4EE5\u53CA\u5904\u7406\u7684handler\u3002</p><p>\u8FD9\u4E9B\u63CF\u8FF0\uFF0C\u4F1A\u5728 RegisterUserServer\u8FD9\u4E2A\u65B9\u6CD5\u4E2D\uFF0C\u6CE8\u518C\u670D\u52A1\u65F6\uFF0C\u4F5C\u4E3A\u53C2\u6570\u4F20\u5165\u3002</p><h2 id="userclient-user-go" tabindex="-1"><a class="header-anchor" href="#userclient-user-go" aria-hidden="true">#</a> userclient/user.go</h2><p>\u63D0\u4F9B\u7528\u6765\u8C03\u7528\u7684userclient\u5BA2\u6237\u7AEF\u3002</p><p>\u5B9A\u4E49\u4E86\u4E00\u8F6E\u8BF7\u6C42\u548C\u8FD4\u56DE\u7C7B\u578B\u3002</p><p>\u5B9A\u4E49\u4E86User\u63A5\u53E3\uFF0CdefaultUser\u7ED3\u6784\u4F53\u3002</p><p>defaultUser\u4F5C\u4E3Areceiver\uFF0C\u5176\u4E0A\u5B9A\u4E49\u4E86\u65B9\u6CD5\u96C6\u5408\u3002</p><p>\u63D0\u4F9B\u4E00\u4E2ANewUser\u65B9\u6CD5\uFF0C\u521D\u59CB\u5316defaultUser\u5E76\u8FD4\u56DE\u5B9E\u4F8B\u3002</p><h2 id="internal-server-userserver-go" tabindex="-1"><a class="header-anchor" href="#internal-server-userserver-go" aria-hidden="true">#</a> internal/server/userserver.go</h2><p>\u63D0\u4F9B\u4E00\u4E2A\u7C7B\u4F3C\u8DEF\u7531\u6216\u8005\u63A7\u5236\u5668\u7684\u529F\u80FD\uFF0C\u628A\u83B7\u53D6\u7684\u8BF7\u6C42\uFF0C\u8F6C\u53D1\u7ED9logic\u5C42\uFF0C\u83B7\u53D6\u7ED3\u679C\u540E\u8FD4\u56DE\u3002</p><p>\u63D0\u4F9BNewUserServer\u529F\u80FD\uFF0C\u7ED9\u5165\u53E3\u8C03\u7528\uFF0C\u7528\u6765\u5728\u542F\u52A8\u670D\u52A1\u540E\uFF0C\u8FDB\u884C\u6CE8\u518C\u3002</p><h2 id="internal-svc-servicecontext-go" tabindex="-1"><a class="header-anchor" href="#internal-svc-servicecontext-go" aria-hidden="true">#</a> internal/svc/servicecontext.go</h2><p>\u5B9A\u4E49ServiceContext\u7ED3\u6784\u4F53\uFF0C\u5176\u5185Config\uFF0C\u8FD8\u53EF\u624B\u52A8\u4E3A\u5176\u6DFB\u52A0Model\u3002</p><p>\u63D0\u4F9BNewServiceContext\u5BF9\u7ED3\u6784\u4F53\u5B9E\u4F8B\u5316\u3002</p><p>Config\u901A\u8FC7\u4E0A\u5C42\u53C2\u6570\u4F20\u5165\u3002Model\u901A\u8FC7Model\u5C42\u7684New\u65B9\u6CD5\u5B9E\u4F8B\u8D4B\u503C\u3002</p><h2 id="internal-logic-loginlogic-go" tabindex="-1"><a class="header-anchor" href="#internal-logic-loginlogic-go" aria-hidden="true">#</a> internal/logic/loginlogic.go</h2><p>\u5B9A\u4E49\u4E1A\u52A1Logic\u7ED3\u6784\u4F53\u3002</p><p>\u7ED3\u6784\u4F53\u5305\u542Bctx\uFF0CsvcCtx\uFF0C\u8FD8\u6709Logger\u3002</p><p>\u63D0\u4F9B\u7ED3\u6784\u4F53\u7684NewLogic\u65B9\u6CD5\u3002</p><p>\u4E3A\u7ED3\u6784\u4F53\u6DFB\u52A0\u4E1A\u52A1\u65B9\u6CD5\u7684\u5177\u4F53\u5B9E\u73B0\uFF0C\u5176\u63A5\u6536\u8F93\u5165\u53C2\u6570\uFF0C\u83B7\u5F97\u8FD4\u56DE\u3002</p>`,45),p=[i];function c(r,o){return s(),e("div",null,p)}var u=n(t,[["render",c],["__file","rpc_draft.html.vue"]]);export{u as default};
